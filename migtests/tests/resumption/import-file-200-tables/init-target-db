#!/usr/bin/env bash

set -e
set -x

# Ensure required environment variables are set
if [[ -z "${TARGET_DB_NAME}" || -z "${SCRIPTS}" ]]; then
    echo "Error: Required environment variables are not set."
    exit 1
fi

source "${SCRIPTS}/functions.sh"

# Function to create multiple tables using a SQL function
function create_tables_sql_function() {
    local db_name=$1
    local table_count=$2

    run_ysql ${db_name} "
    DO \$\$
    BEGIN
        FOR i IN 1..${table_count} LOOP
            EXECUTE format(
                'CREATE TABLE smsa%1\$s (
                    City VARCHAR(50),
                    city_state CHAR(8),
                    Jan_temp SMALLINT,
                    July_temp INTEGER,
                    Relhum BIGINT,
                    Rain INT,
                    Mortality NUMERIC,
                    Education REAL,
                    Pop_density DOUBLE PRECISION,
                    PNonWhite REAL,
                    Pwc NUMERIC,
                    Pop TEXT,
                    Pop_house NUMERIC,
                    Income TEXT,
                    HcPot NUMERIC,
                    NOxpot REAL,
                    SO2pot DOUBLE PRECISION,
                    NOx NUMERIC
                );',
                i
            );
        END LOOP;
    END
    \$\$;
    "
    echo "All ${table_count} tables created successfully."
}

# Step: Create Target Database
step "Create target database."
run_ysql yugabyte "DROP DATABASE IF EXISTS ${TARGET_DB_NAME};"
run_ysql yugabyte "CREATE DATABASE ${TARGET_DB_NAME};"

# Step: Initialize Target Database with 200 tables
create_tables_sql_function ${TARGET_DB_NAME} 200

echo "End of init-db script"
